revoke delete on table "public"."base_users" from "anon";

revoke insert on table "public"."base_users" from "anon";

revoke references on table "public"."base_users" from "anon";

revoke select on table "public"."base_users" from "anon";

revoke trigger on table "public"."base_users" from "anon";

revoke truncate on table "public"."base_users" from "anon";

revoke update on table "public"."base_users" from "anon";

revoke delete on table "public"."base_users" from "authenticated";

revoke insert on table "public"."base_users" from "authenticated";

revoke references on table "public"."base_users" from "authenticated";

revoke select on table "public"."base_users" from "authenticated";

revoke trigger on table "public"."base_users" from "authenticated";

revoke truncate on table "public"."base_users" from "authenticated";

revoke update on table "public"."base_users" from "authenticated";

revoke delete on table "public"."base_users" from "service_role";

revoke insert on table "public"."base_users" from "service_role";

revoke references on table "public"."base_users" from "service_role";

revoke select on table "public"."base_users" from "service_role";

revoke trigger on table "public"."base_users" from "service_role";

revoke truncate on table "public"."base_users" from "service_role";

revoke update on table "public"."base_users" from "service_role";

revoke delete on table "public"."customers" from "anon";

revoke insert on table "public"."customers" from "anon";

revoke references on table "public"."customers" from "anon";

revoke select on table "public"."customers" from "anon";

revoke trigger on table "public"."customers" from "anon";

revoke truncate on table "public"."customers" from "anon";

revoke update on table "public"."customers" from "anon";

revoke delete on table "public"."customers" from "authenticated";

revoke insert on table "public"."customers" from "authenticated";

revoke references on table "public"."customers" from "authenticated";

revoke select on table "public"."customers" from "authenticated";

revoke trigger on table "public"."customers" from "authenticated";

revoke truncate on table "public"."customers" from "authenticated";

revoke update on table "public"."customers" from "authenticated";

revoke delete on table "public"."customers" from "service_role";

revoke insert on table "public"."customers" from "service_role";

revoke references on table "public"."customers" from "service_role";

revoke select on table "public"."customers" from "service_role";

revoke trigger on table "public"."customers" from "service_role";

revoke truncate on table "public"."customers" from "service_role";

revoke update on table "public"."customers" from "service_role";

revoke delete on table "public"."gerba_storage" from "anon";

revoke insert on table "public"."gerba_storage" from "anon";

revoke references on table "public"."gerba_storage" from "anon";

revoke select on table "public"."gerba_storage" from "anon";

revoke trigger on table "public"."gerba_storage" from "anon";

revoke truncate on table "public"."gerba_storage" from "anon";

revoke update on table "public"."gerba_storage" from "anon";

revoke delete on table "public"."gerba_storage" from "authenticated";

revoke insert on table "public"."gerba_storage" from "authenticated";

revoke references on table "public"."gerba_storage" from "authenticated";

revoke select on table "public"."gerba_storage" from "authenticated";

revoke trigger on table "public"."gerba_storage" from "authenticated";

revoke truncate on table "public"."gerba_storage" from "authenticated";

revoke update on table "public"."gerba_storage" from "authenticated";

revoke delete on table "public"."gerba_storage" from "service_role";

revoke insert on table "public"."gerba_storage" from "service_role";

revoke references on table "public"."gerba_storage" from "service_role";

revoke select on table "public"."gerba_storage" from "service_role";

revoke trigger on table "public"."gerba_storage" from "service_role";

revoke truncate on table "public"."gerba_storage" from "service_role";

revoke update on table "public"."gerba_storage" from "service_role";

revoke delete on table "public"."gerba_user" from "anon";

revoke insert on table "public"."gerba_user" from "anon";

revoke references on table "public"."gerba_user" from "anon";

revoke select on table "public"."gerba_user" from "anon";

revoke trigger on table "public"."gerba_user" from "anon";

revoke truncate on table "public"."gerba_user" from "anon";

revoke update on table "public"."gerba_user" from "anon";

revoke delete on table "public"."gerba_user" from "authenticated";

revoke insert on table "public"."gerba_user" from "authenticated";

revoke references on table "public"."gerba_user" from "authenticated";

revoke select on table "public"."gerba_user" from "authenticated";

revoke trigger on table "public"."gerba_user" from "authenticated";

revoke truncate on table "public"."gerba_user" from "authenticated";

revoke update on table "public"."gerba_user" from "authenticated";

revoke delete on table "public"."gerba_user" from "service_role";

revoke insert on table "public"."gerba_user" from "service_role";

revoke references on table "public"."gerba_user" from "service_role";

revoke select on table "public"."gerba_user" from "service_role";

revoke trigger on table "public"."gerba_user" from "service_role";

revoke truncate on table "public"."gerba_user" from "service_role";

revoke update on table "public"."gerba_user" from "service_role";

revoke delete on table "public"."items" from "anon";

revoke insert on table "public"."items" from "anon";

revoke references on table "public"."items" from "anon";

revoke select on table "public"."items" from "anon";

revoke trigger on table "public"."items" from "anon";

revoke truncate on table "public"."items" from "anon";

revoke update on table "public"."items" from "anon";

revoke delete on table "public"."items" from "authenticated";

revoke insert on table "public"."items" from "authenticated";

revoke references on table "public"."items" from "authenticated";

revoke select on table "public"."items" from "authenticated";

revoke trigger on table "public"."items" from "authenticated";

revoke truncate on table "public"."items" from "authenticated";

revoke update on table "public"."items" from "authenticated";

revoke delete on table "public"."items" from "service_role";

revoke insert on table "public"."items" from "service_role";

revoke references on table "public"."items" from "service_role";

revoke select on table "public"."items" from "service_role";

revoke trigger on table "public"."items" from "service_role";

revoke truncate on table "public"."items" from "service_role";

revoke update on table "public"."items" from "service_role";

revoke delete on table "public"."permission_types" from "anon";

revoke insert on table "public"."permission_types" from "anon";

revoke references on table "public"."permission_types" from "anon";

revoke select on table "public"."permission_types" from "anon";

revoke trigger on table "public"."permission_types" from "anon";

revoke truncate on table "public"."permission_types" from "anon";

revoke update on table "public"."permission_types" from "anon";

revoke delete on table "public"."permission_types" from "authenticated";

revoke insert on table "public"."permission_types" from "authenticated";

revoke references on table "public"."permission_types" from "authenticated";

revoke select on table "public"."permission_types" from "authenticated";

revoke trigger on table "public"."permission_types" from "authenticated";

revoke truncate on table "public"."permission_types" from "authenticated";

revoke update on table "public"."permission_types" from "authenticated";

revoke delete on table "public"."permission_types" from "service_role";

revoke insert on table "public"."permission_types" from "service_role";

revoke references on table "public"."permission_types" from "service_role";

revoke select on table "public"."permission_types" from "service_role";

revoke trigger on table "public"."permission_types" from "service_role";

revoke truncate on table "public"."permission_types" from "service_role";

revoke update on table "public"."permission_types" from "service_role";

revoke delete on table "public"."permissions" from "anon";

revoke insert on table "public"."permissions" from "anon";

revoke references on table "public"."permissions" from "anon";

revoke select on table "public"."permissions" from "anon";

revoke trigger on table "public"."permissions" from "anon";

revoke truncate on table "public"."permissions" from "anon";

revoke update on table "public"."permissions" from "anon";

revoke delete on table "public"."permissions" from "authenticated";

revoke insert on table "public"."permissions" from "authenticated";

revoke references on table "public"."permissions" from "authenticated";

revoke select on table "public"."permissions" from "authenticated";

revoke trigger on table "public"."permissions" from "authenticated";

revoke truncate on table "public"."permissions" from "authenticated";

revoke update on table "public"."permissions" from "authenticated";

revoke delete on table "public"."permissions" from "service_role";

revoke insert on table "public"."permissions" from "service_role";

revoke references on table "public"."permissions" from "service_role";

revoke select on table "public"."permissions" from "service_role";

revoke trigger on table "public"."permissions" from "service_role";

revoke truncate on table "public"."permissions" from "service_role";

revoke update on table "public"."permissions" from "service_role";

revoke delete on table "public"."reservations" from "anon";

revoke insert on table "public"."reservations" from "anon";

revoke references on table "public"."reservations" from "anon";

revoke select on table "public"."reservations" from "anon";

revoke trigger on table "public"."reservations" from "anon";

revoke truncate on table "public"."reservations" from "anon";

revoke update on table "public"."reservations" from "anon";

revoke delete on table "public"."reservations" from "authenticated";

revoke insert on table "public"."reservations" from "authenticated";

revoke references on table "public"."reservations" from "authenticated";

revoke select on table "public"."reservations" from "authenticated";

revoke trigger on table "public"."reservations" from "authenticated";

revoke truncate on table "public"."reservations" from "authenticated";

revoke update on table "public"."reservations" from "authenticated";

revoke delete on table "public"."reservations" from "service_role";

revoke insert on table "public"."reservations" from "service_role";

revoke references on table "public"."reservations" from "service_role";

revoke select on table "public"."reservations" from "service_role";

revoke trigger on table "public"."reservations" from "service_role";

revoke truncate on table "public"."reservations" from "service_role";

revoke update on table "public"."reservations" from "service_role";

revoke delete on table "public"."residents" from "anon";

revoke insert on table "public"."residents" from "anon";

revoke references on table "public"."residents" from "anon";

revoke select on table "public"."residents" from "anon";

revoke trigger on table "public"."residents" from "anon";

revoke truncate on table "public"."residents" from "anon";

revoke update on table "public"."residents" from "anon";

revoke delete on table "public"."residents" from "authenticated";

revoke insert on table "public"."residents" from "authenticated";

revoke references on table "public"."residents" from "authenticated";

revoke select on table "public"."residents" from "authenticated";

revoke trigger on table "public"."residents" from "authenticated";

revoke truncate on table "public"."residents" from "authenticated";

revoke update on table "public"."residents" from "authenticated";

revoke delete on table "public"."residents" from "service_role";

revoke insert on table "public"."residents" from "service_role";

revoke references on table "public"."residents" from "service_role";

revoke select on table "public"."residents" from "service_role";

revoke trigger on table "public"."residents" from "service_role";

revoke truncate on table "public"."residents" from "service_role";

revoke update on table "public"."residents" from "service_role";

revoke delete on table "public"."transactions" from "anon";

revoke insert on table "public"."transactions" from "anon";

revoke references on table "public"."transactions" from "anon";

revoke select on table "public"."transactions" from "anon";

revoke trigger on table "public"."transactions" from "anon";

revoke truncate on table "public"."transactions" from "anon";

revoke update on table "public"."transactions" from "anon";

revoke delete on table "public"."transactions" from "authenticated";

revoke insert on table "public"."transactions" from "authenticated";

revoke references on table "public"."transactions" from "authenticated";

revoke select on table "public"."transactions" from "authenticated";

revoke trigger on table "public"."transactions" from "authenticated";

revoke truncate on table "public"."transactions" from "authenticated";

revoke update on table "public"."transactions" from "authenticated";

revoke delete on table "public"."transactions" from "service_role";

revoke insert on table "public"."transactions" from "service_role";

revoke references on table "public"."transactions" from "service_role";

revoke select on table "public"."transactions" from "service_role";

revoke trigger on table "public"."transactions" from "service_role";

revoke truncate on table "public"."transactions" from "service_role";

revoke update on table "public"."transactions" from "service_role";

revoke delete on table "public"."washing_machines" from "anon";

revoke insert on table "public"."washing_machines" from "anon";

revoke references on table "public"."washing_machines" from "anon";

revoke select on table "public"."washing_machines" from "anon";

revoke trigger on table "public"."washing_machines" from "anon";

revoke truncate on table "public"."washing_machines" from "anon";

revoke update on table "public"."washing_machines" from "anon";

revoke delete on table "public"."washing_machines" from "authenticated";

revoke insert on table "public"."washing_machines" from "authenticated";

revoke references on table "public"."washing_machines" from "authenticated";

revoke select on table "public"."washing_machines" from "authenticated";

revoke trigger on table "public"."washing_machines" from "authenticated";

revoke truncate on table "public"."washing_machines" from "authenticated";

revoke update on table "public"."washing_machines" from "authenticated";

revoke delete on table "public"."washing_machines" from "service_role";

revoke insert on table "public"."washing_machines" from "service_role";

revoke references on table "public"."washing_machines" from "service_role";

revoke select on table "public"."washing_machines" from "service_role";

revoke trigger on table "public"."washing_machines" from "service_role";

revoke truncate on table "public"."washing_machines" from "service_role";

revoke update on table "public"."washing_machines" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.add_reservation_with_range(p_machine_id integer, p_slot_start timestamp with time zone, p_slot_end timestamp with time zone, p_note text DEFAULT NULL::text)
 RETURNS bigint
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    slot_start_utc TIMESTAMPTZ;
    slot_end_utc TIMESTAMPTZ;
    current_user_uuid UUID;
    current_user_id BIGINT;
    inserted_id BIGINT;
BEGIN
    -- Get the current authenticated user's UUID from Supabase Auth
    current_user_uuid := auth.uid();

    -- Resolve the bigint user_id from gerba_user using auth_user_id
    SELECT id INTO current_user_id
    FROM gerba_user
    WHERE auth_user_id = current_user_uuid;

    -- Ensure the user exists
    IF current_user_id IS NULL THEN
        RAISE EXCEPTION 'User not found in gerba_user table';
    END IF;

    -- Quantize start to whole hour (floor)
    slot_start_utc := date_trunc('hour', p_slot_start);

    -- Quantize end to whole hour (ceil)
    IF date_trunc('hour', p_slot_end) = p_slot_end THEN
        slot_end_utc := p_slot_end;
    ELSE
        slot_end_utc := date_trunc('hour', p_slot_end) + INTERVAL '1 hour';
    END IF;

    -- Insert reservation using the bigint user_id
    INSERT INTO reservations (machine_id, user_id, slot, note)
    VALUES (p_machine_id, current_user_id, tstzrange(slot_start_utc, slot_end_utc, '[)'), p_note)
    RETURNING id INTO inserted_id;

    RETURN inserted_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.current_user_has_permission(permission_name text)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM public.permissions p
    JOIN public.permission_types pt ON pt.id = p.permission_type
    JOIN public.customers c ON c.id = p.user_id
    WHERE c.user_link = (SELECT auth.uid())
      AND pt.name = permission_name
  );
$function$
;

CREATE OR REPLACE FUNCTION public.get_reservations_for_user(p_gerba_user_id bigint)
 RETURNS TABLE(reservation_id bigint, machine_id integer, machine_name text, slot_start_utc timestamp with time zone, slot_end_utc timestamp with time zone, note text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        r.id AS reservation_id,
        wm.id AS machine_id,
        wm.name AS machine_name,
        lower(r.slot) AS slot_start_utc,
        upper(r.slot) AS slot_end_utc,
        r.note
    FROM reservations r
    JOIN washing_machines wm ON wm.id = r.machine_id
    WHERE r.user_id = p_gerba_user_id
    ORDER BY lower(r.slot) ASC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_reservations_week(p_date timestamp with time zone)
 RETURNS TABLE(reservation_id bigint, machine_id integer, machine_name text, user_id uuid, created_at timestamp with time zone, name text, surname text, room integer, phone_number text, date_of_birth date, auth_user_id uuid, slot_start_utc timestamp without time zone, slot_end_utc timestamp without time zone, slot_index_local integer, note text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        r.id,
        r.machine_id,
        wm.name as machine_name,
        gu.auth_user_id AS user_id,
        gu.created_at,
        gu.first_name,
        gu.surname,
        gu.room,
        gu.phone_number,
        gu.data_of_birth,
        gu.auth_user_id,
        lower(r.slot) AT TIME ZONE 'UTC' AS slot_start_utc,
        upper(r.slot) AT TIME ZONE 'UTC' AS slot_end_utc,
        ((date_part('hour', lower(r.slot) AT TIME ZONE 'Europe/Ljubljana')::int / 3) + 1) AS slot_index_local,
        r.note
    FROM reservations r
    JOIN washing_machines wm ON wm.id = r.machine_id
    LEFT JOIN gerba_user gu ON gu.id = r.user_id
    WHERE lower(r.slot) >= p_date
      AND lower(r.slot) < p_date + interval '7 days'
    ORDER BY lower(r.slot);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_slots_for_day(p_date timestamp with time zone)
 RETURNS TABLE(machine_id integer, machine_name text, slot_start_utc timestamp with time zone, slot_end_utc timestamp with time zone, slot_index_local integer, is_empty boolean, reservation_id bigint, user_id uuid, created_at timestamp with time zone, first_name text, surname text, room integer, phone_number text, date_of_birth date, auth_user_id uuid, note text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    WITH slot_definitions AS (
        SELECT generate_series(0, 7) AS slot_index_local
    ),
    machines AS (
        SELECT id, name FROM washing_machines
    ),
    slots AS (
        SELECT
            m.id AS machine_id,
            m.name AS machine_name,
            s.slot_index_local,
            -- keep TIMESTAMPTZ: cast the final value
            (
                date_trunc('day', p_date AT TIME ZONE 'Europe/Ljubljana')
                + (s.slot_index_local * INTERVAL '3 hours')
            ) AT TIME ZONE 'Europe/Ljubljana' AS slot_start_utc,
            (
                date_trunc('day', p_date AT TIME ZONE 'Europe/Ljubljana')
                + ((s.slot_index_local + 1) * INTERVAL '3 hours')
            ) AT TIME ZONE 'Europe/Ljubljana' AS slot_end_utc
        FROM slot_definitions s
        CROSS JOIN machines m
    )
    SELECT
        sl.machine_id,
        sl.machine_name,
        sl.slot_start_utc,
        sl.slot_end_utc,
        sl.slot_index_local + 1,
        r.id IS NULL,
        r.id,
        gu.auth_user_id,
        gu.created_at,
        gu.first_name,
        gu.surname,
        gu.room,
        gu.phone_number,
        gu.data_of_birth,   -- fixed typo
        gu.auth_user_id,
        r.note
    FROM slots sl
    LEFT JOIN reservations r
           ON r.machine_id = sl.machine_id
          AND lower(r.slot) = sl.slot_start_utc
    LEFT JOIN gerba_user gu
           ON gu.id = r.user_id
    ORDER BY sl.machine_id, sl.slot_start_utc;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_total_summary(datefrom timestamp with time zone, dateto timestamp with time zone)
 RETURNS TABLE(total_ordered numeric, total_paid numeric, total_value numeric, total_debt numeric, total_beer_count numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    WITH total_data AS (
        SELECT 
            COALESCE(SUM(t.ordered), 0::NUMERIC) AS total_ordered,
            COALESCE(SUM(t.paid), 0::NUMERIC) AS total_paid,
            COALESCE(SUM(i.price * t.ordered::NUMERIC), 0::NUMERIC) AS total_value,
            COALESCE(
                SUM(i.price * t.ordered::NUMERIC) - SUM(t.paid),
                0::NUMERIC
            ) AS total_debt,
            COALESCE(SUM(i.beer_count * t.ordered), 0::BIGINT::NUMERIC) AS total_beer_count
        FROM 
            transactions t
            LEFT JOIN items i ON t.item = i.id
        WHERE 
            t.ordered_at BETWEEN dateFrom AND dateTo
    )
    SELECT 
        total_data.total_ordered,
        total_data.total_paid,
        total_data.total_value,
        total_data.total_debt,
        total_data.total_beer_count 
    FROM 
        total_data;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_expanded(p_gerba_user_id bigint)
 RETURNS TABLE(gerba_user_id bigint, created_at timestamp with time zone, name text, surname text, room integer, phone_number text, date_of_birth date, auth_user_id uuid, auth_email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        gu.id AS gerba_user_id,
        gu.created_at,
        gu.name,
        gu.surname,
        gu.room,
        gu.phone_number,
        gu.data_of_birth,
        gu.auth_user_id,
        au.email::text AS auth_email
    FROM gerba_user gu
    JOIN auth.users au ON au.id = gu.auth_user_id
    WHERE gu.id = p_gerba_user_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_expanded_from_auth()
 RETURNS TABLE(auth_user_id uuid, auth_email text, auth_created_at timestamp with time zone, gerba_user_id bigint, gerba_name text, gerba_surname text, gerba_room integer, gerba_phone_number text, gerba_data_of_birth date)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        au.id AS auth_user_id,
        au.email::text AS auth_email,
        au.created_at::timestamptz AS auth_created_at,  -- Explicit cast here
        gu.id AS gerba_user_id,
        gu.first_name AS gerba_name,
        gu.surname AS gerba_surname,
        gu.room AS gerba_room,
        gu.phone_number AS gerba_phone_number,
        gu.data_of_birth AS gerba_data_of_birth
    FROM auth.users au
    JOIN gerba_user gu ON gu.auth_user_id = au.id
    WHERE au.id = auth.uid();
END;
$function$
;

CREATE OR REPLACE FUNCTION public.slot_range_from_date_index(p_date date, p_slot_index integer, p_tz text DEFAULT NULL::text)
 RETURNS tstzrange
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
DECLARE
    start_ts TIMESTAMP;
    start_tz TIMESTAMPTZ;
    end_tz TIMESTAMPTZ;
BEGIN
    IF p_slot_index < 1 OR p_slot_index > 6 THEN
        RAISE EXCEPTION 'slot_index must be between 1 and 6';
    END IF;

    -- compute start as date + (slot_index-1)*4 hours (timestamp without tz)
    start_ts := (p_date::timestamp + ( (p_slot_index - 1) * INTERVAL '4 hours' ));

    IF p_tz IS NULL OR length(trim(p_tz)) = 0 THEN
        -- cast to timestamptz using session timezone
        start_tz := start_ts::timestamptz;
    ELSE
        -- interpret start_ts as time in p_tz, convert to timestamptz
        -- (timestamp without tz) AT TIME ZONE zone -> timestamptz
        start_tz := start_ts AT TIME ZONE p_tz;
    END IF;

    end_tz := start_tz + INTERVAL '4 hours';

    RETURN tstzrange(start_tz, end_tz, '[)');
END;
$function$
;



